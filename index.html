<!doctype html>
<html lang="tr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>GenÃ§ Gross Mobil Terminal â€” Barkod + Adet â†’ TXT</title>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#1C2AAE">
<style>
  :root{--blue:#1C2AAE;--orange:#F0552C;--bg:#fff;--card:#f6f8ff;--text:#102050;--muted:#667;--ok:#1fbf75;--warn:#ff5d5d}
  *{box-sizing:border-box}
  body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;margin:0;background:var(--bg);color:var(--text)}
  header{padding:14px 10px;background:linear-gradient(90deg,var(--orange),var(--blue));color:#fff}
  header .wrap{max-width:980px;margin:auto;display:flex;justify-content:space-between;align-items:center}
  header .ttl{font-weight:800;letter-spacing:.3px}
  .wrap{max-width:980px;margin:auto;padding:10px}
  .card{margin:10px 0;padding:12px;background:var(--card);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.06)}
  button{padding:8px 12px;margin:2px;border-radius:10px;border:none;cursor:pointer;font-weight:700}
  .primary{background:var(--blue);color:#fff}
  .accent{background:var(--orange);color:#fff}
  .good{background:var(--ok);color:#fff}
  .warn{background:var(--warn);color:#fff}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  label{font-size:13px}
  input[type="file"],input[type="text"],input[type="number"],input[type="tel"],select{border:1px solid #d6daf2;border-radius:8px;padding:8px}
  table{width:100%;border-collapse:collapse;margin-top:10px}
  th,td{border-bottom:1px solid #dbe1ff;padding:8px}
  th{background:#e9edff;color:#233}
  .right{text-align:right}
  .muted{color:var(--muted);font-size:12px}
  .chip{display:inline-block;background:#e8ecff;color:#334;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:6px;border:1px solid #d6daf2}
  .videoBox{position:relative;border-radius:12px;overflow:hidden;background:#000}
  video{display:block;width:100%;max-height:320px}
  .roi{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
  .roi:after{content:"";width:68%;height:32%;border:2px solid rgba(255,255,255,.9);border-radius:10px;box-shadow:0 0 0 200vmax rgba(0,0,0,.35) inset}
  .qtybtn{padding:6px 10px;border:1px solid #d6daf2;background:#fff;border-radius:8px}
  .pname{font-weight:700;color:#0a7a2b}
  .pprice{font-weight:700;color:#a14900}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="ttl">ðŸ“¦ GENÃ‡ GROSS â€¢ Mobil Terminal</div>
    <div>Barkod + Adet â†’ TXT</div>
  </div>
</header>

<div class="wrap">
  <!-- KAMERA -->
  <div class="card">
    <div class="row">
      <label>Kamera:</label>
      <select id="cameraSelect"></select>
      <button id="btnStart" class="primary">KamerayÄ± BaÅŸlat</button>
      <button id="btnStop">Durdur</button>
      <button id="btnScanOnce" class="accent" style="margin-left:auto">ðŸ‘‰ Tek Okut</button>
    </div>
    <div class="videoBox">
      <video id="video" playsinline autoplay muted></video>
      <div class="roi"></div>
    </div>
    <div class="status">
      <span id="scanStatus" class="chip">HazÄ±r</span>
      <span id="fps" class="chip">FPS: -</span>
    </div>
    <div class="muted">Ä°pucu: Barkodu kutunun iÃ§inde, 15â€“25 cm mesafe, iyi Ä±ÅŸÄ±k.</div>
  </div>

  <!-- LÄ°STE + GÄ°RÄ°Åž -->
  <div class="card">
    <label>Barkod & Adet</label>
    <div class="row">
      <input id="barcode" type="tel" inputmode="numeric" pattern="[0-9]*"
             autocomplete="off" placeholder="Barkod" style="flex:1;min-width:220px" />
      <button id="btnOk" class="accent">Tamam</button>
      <button id="btnClearField">Temizle</button>
    </div>
    <div class="row">
      <button id="btnMinus" class="qtybtn">âˆ’1</button>
      <input id="qty" type="number" value="1" min="1" step="1" style="width:90px;text-align:center" />
      <button id="btnPlus" class="qtybtn">+1</button>
      <button id="btnAdd" class="good">Ekle</button>
      <button id="btnUndo">Geri Al</button>
    </div>

    <div class="muted">ÃœrÃ¼n: <span id="productName" class="pname">â€”</span> Â· Fiyat: <span id="productPrice" class="pprice">â€”</span></div>

    <label>Dosya AdÄ±:</label>
    <input id="filename" placeholder="sayim" style="width:60%" />

    <div class="row" style="margin-top:8px">
      <button id="btnExport" class="primary">TXT Olarak DÄ±ÅŸa Aktar</button>
      <button id="btnCSV" class="accent">CSV Olarak DÄ±ÅŸa Aktar</button>
      <button id="btnClear" class="warn">Listeyi Temizle</button>
    </div>

    <table>
      <thead><tr><th>Barkod</th><th>Ä°sim</th><th class="right">Adet</th><th></th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
    Toplam satÄ±r: <span id="totalRows">0</span> Â· Toplam adet: <span id="totalQty">0</span>
  </div>

  <!-- ÃœRÃœN VERÄ°SÄ° -->
  <div class="card">
    <h3 style="margin:4px 0 8px 0">ÃœrÃ¼n Verisi YÃ¼kle (opsiyonel)</h3>
    <div class="muted">
      GDF/TXT (ERP Ã§Ä±ktÄ±sÄ±) veya CSV/JSON yÃ¼kleyebilirsin. CSV Ã¶rnek: <code>barkod;isim;fiyat</code><br>
      <b>GDF Fiyat SÃ¼tunu (ops.)</b>:
      <input id="gdfCol" type="number" min="1" style="width:90px" placeholder="Ã¶rn. 6">
      <small>(BoÅŸ bÄ±rakÄ±lÄ±rsa satÄ±rÄ±n <u>en saÄŸÄ±ndaki</u> fiyat kullanÄ±lÄ±r)</small>
    </div>
    <div class="row">
      <input id="productFile" type="file" accept=".gdf,.txt,.csv,.json" />
      <button id="btnClearMap" class="warn">ÃœrÃ¼n Verisini Temizle</button>
      <span class="chip" id="mapStat">0 Ã¼rÃ¼n yÃ¼klÃ¼</span>
    </div>
  </div>

  <!-- Sesler -->
  <audio id="beep"  src="beep.ogg"  preload="auto"></audio>
  <!-- BulunamadÄ± iÃ§in Ã¶nce yerel error.ogg, yoksa online yedek -->
  <audio id="errorSound" preload="auto"></audio>
</div>

<script>
  // ---------- Durum ----------
  const state={items:{},scanning:false,currentDeviceId:null,singleShot:false};
  let mediaStream=null,rafId=null,frames=0,duplicateGuard={code:null,until:0},lastOp=null,detector=null,off=null,octx=null;
  let productMap={};

  // ---------- ElÃ§iler ----------
  const selCam=document.getElementById('cameraSelect');
  const video=document.getElementById('video');
  const statusEl=document.getElementById('scanStatus');
  const fpsEl=document.getElementById('fps');
  const barcodeInp=document.getElementById('barcode');
  const qtyInp=document.getElementById('qty');
  const tbody=document.getElementById('tbody');
  const totalRows=document.getElementById('totalRows');
  const totalQty=document.getElementById('totalQty');
  const filenameInp=document.getElementById('filename');
  const beep=document.getElementById('beep');
  const errorSound=document.getElementById('errorSound');
  const btnScanOnce=document.getElementById('btnScanOnce');
  const btnOk=document.getElementById('btnOk');
  const productNameEl=document.getElementById('productName');
  const productPriceEl=document.getElementById('productPrice');
  const productFile=document.getElementById('productFile');
  const mapStat=document.getElementById('mapStat');
  const gdfColInp=document.getElementById('gdfCol');

  // ---------- Ses fallback (YouTube doÄŸrudan Ã§almaz) ----------
  (function setupErrorAudio(){
    // Ã–nce yerelde error.ogg var mÄ± dene, yoksa online kÄ±sa alarm sesine dÃ¼ÅŸ.
    fetch('error.ogg',{method:'HEAD'}).then(r=>{
      errorSound.src = r.ok ? 'error.ogg' : 'https://actions.google.com/sounds/v1/alarms/beep_short.ogg';
    }).catch(()=>{ errorSound.src='https://actions.google.com/sounds/v1/alarms/beep_short.ogg'; });
  })();

  // ---------- Liste render ----------
  function render(){
    tbody.innerHTML=''; let sum=0;
    Object.entries(state.items).forEach(([c,q])=>{
      sum+=Number(q)||0;
      const name=(productMap[c]?.name)||'â€”';
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${c}</td><td>${name}</td><td class="right">${q}</td><td><button onclick="del('${c}')">Sil</button></td>`;
      tbody.appendChild(tr);
    });
    totalRows.textContent=Object.keys(state.items).length;
    totalQty.textContent=sum;
  }
  window.del=(c)=>{delete state.items[c];save();render();}
  function upsert(c,q){if(!c)return;const n=Math.max(1,Number(q)||1);state.items[c]=(Number(state.items[c])||0)+n;lastOp={code:c,qty:n};save();render();}
  function undo(){if(!lastOp)return;const {code,qty}=lastOp;state.items[code]=(Number(state.items[code])||0)-qty;if(state.items[code]<=0)delete state.items[code];lastOp=null;save();render();}
  function save(){localStorage.setItem('barcodeItems',JSON.stringify(state.items));}
  function load(){const raw=localStorage.getItem('barcodeItems');if(raw){try{state.items=JSON.parse(raw);}catch{}}render();}

  // ---------- DÄ±ÅŸa aktarma ----------
  function dl(name,content,type){const a=document.createElement('a');a.href=URL.createObjectURL(new Blob([content],{type}));a.download=name;a.click();URL.revokeObjectURL(a.href);}
  function exportTXT(){const lines=Object.entries(state.items).map(([c,q])=>`${c};${q}`);dl((filenameInp.value||'sayim')+'.txt',lines.join('\n'),'text/plain');}
  function exportCSV(){const lines=['barcode,name,qty',...Object.entries(state.items).map(([c,q])=>`${c},"${(productMap[c]?.name||'').replace(/"/g,'""')}",${q}`)];dl((filenameInp.value||'sayim')+'.csv',lines.join('\n'),'text/csv');}

  // ---------- Kamera ----------
  async function listCameras(){
    try{
      const devices=await navigator.mediaDevices.enumerateDevices();
      const videos=devices.filter(d=>d.kind==='videoinput');
      selCam.innerHTML='';
      videos.forEach((d,i)=>{const o=document.createElement('option');o.value=d.deviceId;o.textContent=d.label||`Kamera ${i+1}`;selCam.appendChild(o);});
      const rear=videos.find(d=>/back|rear|arka/i.test(d.label||''));state.currentDeviceId=rear?.deviceId||videos[0]?.deviceId||null;
      if(state.currentDeviceId)selCam.value=state.currentDeviceId;
    }catch(e){}
  }
  selCam.onchange=()=>{state.currentDeviceId=selCam.value;if(state.scanning)start();};

  async function start(){
    stop();statusEl.textContent='Kamera aÃ§Ä±lÄ±yor...';
    try{
      const constraints={video:state.currentDeviceId?{deviceId:{exact:state.currentDeviceId},width:{ideal:1920},height:{ideal:1080}}:{facingMode:{ideal:'environment'},width:{ideal:1920},height:{ideal:1080}},audio:false};
      mediaStream=await navigator.mediaDevices.getUserMedia(constraints);
      video.srcObject=mediaStream;await video.play();state.scanning=true;statusEl.textContent='Tarama aktif';runNativeLoop();fpsCounter();
    }catch(e){statusEl.textContent='Tarama baÅŸlatÄ±lamadÄ±';}
  }
  function stop(){
    cancelAnimationFrame(rafId);rafId=null;frames=0;fpsEl.textContent='FPS: -';
    const s=video.srcObject;if(s?.getTracks)s.getTracks().forEach(t=>t.stop());video.srcObject=null;mediaStream=null;state.scanning=false;statusEl.textContent='Durduruldu';
  }
  function fpsCounter(){let last=performance.now();const tick=()=>{if(!state.scanning)return;const now=performance.now();if(now-last>=1000){fpsEl.textContent='FPS: '+frames;frames=0;last=now;}requestAnimationFrame(tick);};tick();}

  // ---------- Barkod iÅŸleme ----------
  function showProductInfo(code){
    const p=productMap[code];
    if(p){productNameEl.textContent=p.name||'â€”';productPriceEl.textContent=p.price||'â€”';}
    else{productNameEl.textContent='BulunamadÄ±';productPriceEl.textContent='â€”';}
  }
  function onCode(text){
    if(!text)return;const now=performance.now();
    if(text===duplicateGuard.code&&now<duplicateGuard.until)return;duplicateGuard={code:text,until:now+1500};
    barcodeInp.value=text; showProductInfo(text);
    const found=!!productMap[text];
    try{ (found?beep:errorSound).currentTime=0; (found?beep:errorSound).play(); }catch(_){}
    if(navigator.vibrate)navigator.vibrate(found?30:80);
    if(state.singleShot){stop();btnScanOnce.disabled=true;btnScanOnce.textContent='Okundu âœ“';setTimeout(()=>{btnScanOnce.disabled=false;btnScanOnce.textContent='ðŸ‘‰ Tek Okut';},900);state.singleShot=false;}
  }

  // ---------- Yerel dÃ¶ngÃ¼ ----------
  async function runNativeLoop(){
    if(!('BarcodeDetector' in window)){statusEl.textContent='Desteklenmiyor';return;}
    if(!detector){detector=new BarcodeDetector({formats:['ean_13','ean_8','code_128','code_39','itf','upc_e','upc_a']});}
    if(!off){off=document.createElement('canvas');octx=off.getContext('2d',{willReadFrequently:true});}
    const loop=async()=>{
      if(!state.scanning)return;frames++;
      const vw=video.videoWidth,vh=video.videoHeight;
      if(vw&&vh){
        const rw=Math.floor(vw*0.68),rh=Math.floor(vh*0.32);
        const rx=Math.floor((vw-rw)/2),ry=Math.floor((vh-rh)/2);
        off.width=rw;off.height=rh;octx.drawImage(video,rx,ry,rw,rh,0,0,rw,rh);
        try{const d=await detector.detect(off);if(d&&d.length){onCode((d[0].rawValue||'').trim());}}catch(_){}
      }
      if(state.scanning)rafId=requestAnimationFrame(loop);
    };loop();
  }

  // ---------- ÃœrÃ¼n verisi yÃ¼kleme ----------
  document.getElementById('btnClearMap').onclick=()=>{productMap={};localStorage.removeItem('productMap');mapStat.textContent='0 Ã¼rÃ¼n yÃ¼klÃ¼';showProductInfo('');};
  gdfColInp.addEventListener('change',()=>{localStorage.setItem('gdfPriceCol', gdfColInp.value.trim());});
  productFile.onchange=async(e)=>{
    const file=e.target.files?.[0];if(!file)return;
    let txt='';try{txt=await file.text();}catch{alert('Dosya okunamadÄ±.');return;}
    loadProductText(txt,file.name||'dosya');
  };

  function loadProductText(txt,src='metin'){
    try{
      let map={};
      if(txt.startsWith('<SIGNATURE=GNDPLU.GDF>')) map=parseGDF(txt);
      else if(txt.trim().startsWith('{')){
        const obj=JSON.parse(txt);
        for(const [k,v] of Object.entries(obj)){
          if(typeof v==='string') map[k]={name:v,price:''};
          else map[k]={name:v.name||'',price:v.price||''};
        }
      }else map=parseCSV(txt);

      const count=Object.keys(map).length;
      if(count===0){const first=(txt.split(/\r?\n/)[0]||'').slice(0,120);alert(`0 Ã¼rÃ¼n bulundu (${src}). Ä°lk satÄ±r: "${first}"`);return;}
      productMap=map;localStorage.setItem('productMap',JSON.stringify(productMap));mapStat.textContent=count+' Ã¼rÃ¼n yÃ¼klÃ¼';showProductInfo(barcodeInp.value.trim());
      alert(`${count} Ã¼rÃ¼n yÃ¼klendi (${src}).`);
    }catch(err){console.error(err);alert('Veri Ã§Ã¶zÃ¼mlenemedi. CSV/TXT (barkod;isim;fiyat), JSON veya imzalÄ± GDF kullanÄ±n.');}
  }

  // CSV/TXT: barkod;isim;fiyat
  function parseCSV(txt){
    const lines=txt.split(/\r?\n/).filter(x=>x.trim().length);
    const sep=lines[0]?.includes(';')?';':',';
    const map={};
    for(const L of lines){
      const cols=L.split(sep).map(s=>s.trim());
      if(cols.length>=2){
        const bc=cols[0].replace(/\s+/g,'');
        const name=cols[1];
        let price=(cols[2]||'').replace(/\s/g,'');
        price=normPriceStr(price).disp;
        if(/^[0-9]{8,14}$/.test(bc)) map[bc]={name,price};
      }
    }
    return map;
  }

  // --- Fiyat normalizasyonu ve Ã§Ä±karÄ±mÄ± ---
  function normPriceStr(p){
    if(!p) return {num:0,disp:''};
    p = p.replace(/\s+/g,'');        // aralardaki boÅŸluklar
    p = p.replace(/\./g,'');         // binlik noktalarÄ±
    p = p.replace(/^0+(?=\d)/,'');   // baÅŸ sÄ±fÄ±rlar
    if(!/,/.test(p)) return {num:0,disp:''};
    let n = Number(p.replace(',','.'));
    if(!isFinite(n)) n=0;
    return {num:n,disp: n? n.toFixed(2).replace('.',',') : ''};
  }
  function priceFromTextRightmost(txt){
    // 0011,90 | 1.234,50 | 11,90 gibi deÄŸerlerin EN SAÄžDAKÄ°NÄ° al
    const re=/\d{1,3}(?:\.\d{3})*,\d{2}|\d+,\d{2}/g;
    const matches=[]; let m;
    while((m=re.exec(txt))){ const n=normPriceStr(m[0]); if(n.num>0 && n.num<1000) matches.push({pos:m.index,disp:n.disp}); }
    if(!matches.length) return '';
    return matches[matches.length-1].disp;
  }

  // GDF: 01 (PLU+Ä°sim), 02 (Barkod+Fiyat)
  function parseGDF(txt){
    const lines=txt.split(/\r?\n/);
    const names={}; let lastPLU=null; const map={};
    const fixedCol = Number(localStorage.getItem('gdfPriceCol')||gdfColInp.value||'0') || 0; // 1-based; 0 => otomatik

    for(let i=0;i<lines.length;i++){
      const raw=lines[i]; if(!raw) continue;

      if(raw.startsWith('01')){
        const parts=raw.trim().split(/\s{2,}/); // Ã§oklu boÅŸluklarla ayrÄ±lmÄ±ÅŸ
        if(parts.length>=4){ lastPLU=parts[1]; names[lastPLU]=parts[3]; }
        continue;
      }

      if(raw.startsWith('02')){
        let priceDisp = '';
        if(fixedCol>0){
          // sÃ¼tun bazlÄ±: Ã§oklu boÅŸluk gruplayarak ayÄ±r, istenen sÃ¼tunu al
          const cols = raw.trim().split(/\s{2,}/);
          const pick = cols[fixedCol-1] || '';
          priceDisp = normPriceStr(pick).disp || priceFromTextRightmost(raw);
        }else{
          // otomatik: saÄŸdan yakala, komÅŸu satÄ±rlara da bak
          priceDisp = priceFromTextRightmost(raw);
          if(!priceDisp && lines[i+1]) priceDisp = priceFromTextRightmost(lines[i+1]);
          if(!priceDisp && lines[i-1]) priceDisp = priceFromTextRightmost(lines[i-1]);
        }

        // Barkod tespiti (8..14 hane) â€” PLUâ€™yu at
        const nums=(raw.match(/\b\d{8,14}\b/g)||[]);
        const candidates=nums.filter(n=>n!==lastPLU);
        let bc=candidates.filter(n=>n.length===13||n.length===12).pop()
              || candidates.filter(n=>n.length===8).pop()
              || '';

        const name=names[lastPLU]||'';
        if(bc&&name) map[bc]={name,price:priceDisp};
      }
    }
    return map;
  }

  // ---------- UI olaylarÄ± ----------
  document.getElementById('btnStart').onclick=async()=>{await listCameras();start();};
  document.getElementById('btnStop').onclick=()=>stop();
  document.getElementById('btnExport').onclick=()=>exportTXT();
  document.getElementById('btnCSV').onclick=()=>exportCSV();
  document.getElementById('btnClear').onclick=()=>{if(confirm('Listeyi temizlemek istiyor musun?')){state.items={};save();render();}};
  document.getElementById('btnUndo').onclick=()=>undo();
  document.getElementById('btnMinus').onclick=()=>{qtyInp.value=Math.max(1,Number(qtyInp.value)-1);};
  document.getElementById('btnPlus').onclick=()=>{qtyInp.value=Number(qtyInp.value)+1;};
  document.getElementById('btnClearField').onclick=()=>{barcodeInp.value='';showProductInfo('');};
  btnScanOnce.onclick=async()=>{await listCameras();state.singleShot=true;btnScanOnce.disabled=true;btnScanOnce.textContent='Okutuluyor...';if(!state.scanning)await start();else statusEl.textContent='Tek seferlik okuma aktif';};

  // Elle giriÅŸ: Tamam â†’ Ã¼rÃ¼n bilgisi + ses
  btnOk.onclick=()=>{
    const code=barcodeInp.value.replace(/\D/g,''); if(!code) return;
    showProductInfo(code);
    const found=!!productMap[code];
    try{ (found?beep:errorSound).currentTime=0; (found?beep:errorSound).play(); }catch(_){}
    if(navigator.vibrate)navigator.vibrate(found?30:80);
    qtyInp.focus(); qtyInp.select();
  };

  // Yazarken Ã¼rÃ¼n gÃ¶ster (gÃ¼rÃ¼ltÃ¼ olmasÄ±n diye 8+ hanede)
  barcodeInp.addEventListener('input',()=>{const code=barcodeInp.value.replace(/\D/g,'');if(code.length>=8)showProductInfo(code);});
  barcodeInp.addEventListener('blur',()=>{const code=barcodeInp.value.replace(/\D/g,'');if(code)showProductInfo(code);});

  document.getElementById('btnAdd').onclick=()=>{upsert(barcodeInp.value.trim(),qtyInp.value);barcodeInp.value='';qtyInp.value=1;showProductInfo('');barcodeInp.focus();};

  // KalÄ±cÄ± ayarlarÄ± yÃ¼kle
  try{
    const pm=localStorage.getItem('productMap');if(pm){productMap=JSON.parse(pm);mapStat.textContent=Object.keys(productMap).length+' Ã¼rÃ¼n yÃ¼klÃ¼';}
    const gc=localStorage.getItem('gdfPriceCol');if(gc){gdfColInp.value=gc;}
  }catch{}
  load();listCameras();

  // PWA servis Ã§alÄ±ÅŸanÄ±
  if('serviceWorker' in navigator){
    window.addEventListener('load',()=>navigator.serviceWorker.register('sw.js').catch(()=>{}));
  }
</script>
</body>
</html>
