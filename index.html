<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barkod + Adet â†’ TXT</title>
  <style>
    body{font-family:system-ui;margin:0;padding:0;background:#0b1220;color:#fff}
    header{padding:10px;background:#111a2b;text-align:center}
    .card{margin:10px;padding:10px;background:#1c2944;border-radius:10px}
    button{padding:8px 12px;margin:4px;border-radius:8px;border:none;cursor:pointer}
    button.primary{background:#1677ff;color:#fff}
    button.good{background:#1fbf75;color:#0b261a}
    button.warn{background:#ff5d5d;color:#2b0b0b}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #333;padding:6px}
    th{color:#7f8ca8;text-align:left}
    .right{text-align:right}
    label{display:block;margin-top:6px;font-size:13px}
    .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center}
    .hint{font-size:12px;color:#ffd27b;margin-top:6px}
  </style>
</head>
<body>
  <header>
    <h1>ðŸ“¦ Barkod + Adet â†’ TXT</h1>
  </header>

  <div class="card">
    <label>Kamera SeÃ§:</label>
    <select id="cameraSelect"></select>
    <div class="row">
      <button id="btnStart" class="primary">KamerayÄ± BaÅŸlat</button>
      <button id="btnStop">Durdur</button>
      <label>YakÄ±nlaÅŸtÄ±rma:
        <input id="zoom" type="range" min="1" max="5" step="0.1" value="1">
      </label>
      <label style="display:inline-flex;gap:6px;align-items:center">
        <input id="beepOn" type="checkbox" checked> Bip
      </label>
      <button id="btnPhoto">Foto ile Tara</button>
      <input id="photoInput" type="file" accept="image/*" capture="environment" style="display:none" />
    </div>
    <video id="video" playsinline muted autoplay style="width:100%;max-height:260px;background:#000;border-radius:8px"></video>
    <div id="scanStatus">HazÄ±r</div>
    <div class="hint">
      Ä°pucu: Barkodu kadrajÄ±n %60â€“80â€™ini kaplayacak ÅŸekilde, 15â€“25 cm mesafede ve iyi Ä±ÅŸÄ±kta tut.
    </div>
  </div>

  <div class="card">
    <label>Barkod & Adet</label>
    <div class="row">
      <input id="barcode" placeholder="Barkod" style="flex:1;min-width:220px" />
      <input id="qty" type="number" value="1" min="1" style="width:110px" />
      <button id="btnAdd" class="good">Ekle</button>
    </div>

    <label>Dosya AdÄ± (kaydetmeden Ã¶nce):</label>
    <input id="filename" placeholder="sayim" style="width:60%" />

    <div style="margin-top:6px">SatÄ±r formatÄ±: <code>8697433680118;36</code></div>
    <div class="row" style="margin-top:6px">
      <button id="btnExport" class="primary">TXT Olarak DÄ±ÅŸa Aktar</button>
      <button id="btnCSV">CSV Olarak DÄ±ÅŸa Aktar</button>
      <button id="btnClear" class="warn">Listeyi Temizle</button>
    </div>

    <table>
      <thead>
        <tr><th>Barkod</th><th class="right">Adet</th><th></th></tr>
      </thead>
      <tbody id="tbody"></tbody>
    </table>
    Toplam: <span id="totalRows">0</span>
  </div>

  <!-- ZXing: gÃ¼ncel sÃ¼rÃ¼m -->
  <script src="https://unpkg.com/@zxing/browser@0.1.6"></script>

  <!-- Bip sesi -->
  <audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg" preload="auto"></audio>

  <script>
    // Durum & elemanlar
    const state = {items:{}, reader:null, currentDeviceId:null, scanning:false};
    let mediaStream = null, videoTrack = null;

    const selCam = document.getElementById('cameraSelect');
    const video = document.getElementById('video');
    const barcodeInp = document.getElementById('barcode');
    const qtyInp = document.getElementById('qty');
    const tbody = document.getElementById('tbody');
    const totalRows = document.getElementById('totalRows');
    const statusEl = document.getElementById('scanStatus');
    const photoBtn = document.getElementById('btnPhoto');
    const photoInput = document.getElementById('photoInput');
    const filenameInp = document.getElementById('filename');
    const zoomSlider = document.getElementById('zoom');
    const beep = document.getElementById('beep');
    const beepOn = document.getElementById('beepOn');

    // Liste
    function render(){
      tbody.innerHTML='';
      for (const [c,q] of Object.entries(state.items)){
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${c}</td><td class='right'>${q}</td>
                        <td><button onclick="deleteItem('${c}')">Sil</button></td>`;
        tbody.appendChild(tr);
      }
      totalRows.textContent = Object.keys(state.items).length;
    }
    function deleteItem(c){ delete state.items[c]; saveLocal(); render(); }
    function upsert(c,q){ if(!c) return; const n=Math.max(1,Number(q)||1); state.items[c]=(Number(state.items[c])||0)+n; saveLocal(); render(); }
    function saveLocal(){ localStorage.setItem('barcodeItems', JSON.stringify(state.items)); }
    function loadLocal(){ const raw=localStorage.getItem('barcodeItems'); if(raw){ try{state.items=JSON.parse(raw);}catch{} } render(); }

    // DÄ±ÅŸa aktar
    function downloadFile(name,content,type){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([content],{type})); a.download=name; a.click(); URL.revokeObjectURL(a.href);
    }
    function exportTXT(){ const lines=Object.entries(state.items).map(([c,q])=>`${c};${q}`); downloadFile((filenameInp.value||'sayim')+'.txt', lines.join('\n'), 'text/plain'); }
    function exportCSV(){ const lines=['barcode,qty',...Object.entries(state.items).map(([c,q])=>`${c},${q}`)]; downloadFile((filenameInp.value||'sayim')+'.csv', lines.join('\n'), 'text/csv'); }

    // Kamera listesi
    async function listCameras(){
      try{
        const devices = await ZXingBrowser.BrowserMultiFormatReader.listVideoInputDevices();
        selCam.innerHTML='';
        devices.forEach((d,i)=>{
          const opt=document.createElement('option'); opt.value=d.deviceId; opt.textContent=d.label||`camera ${i+1}`; selCam.appendChild(opt);
        });
        const rear = devices.find(d=>/back|rear|arka/i.test(d.label||'')); 
        state.currentDeviceId = (rear?rear.deviceId:(devices[0]?.deviceId||null));
        if(state.currentDeviceId) selCam.value = state.currentDeviceId;
      }catch(e){ console.warn(e); }
    }
    selCam.onchange = ()=>{ state.currentDeviceId = selCam.value; if(state.scanning) startScanner(); };

    // Basit & saÄŸlam baÅŸlatma
    async function startScanner(){
      stopScanner();
      try{
        state.reader = new ZXingBrowser.BrowserMultiFormatReader();
        statusEl.textContent = 'Tarama aktif';
        state.scanning = true;

        const deviceId = state.currentDeviceId ? { exact: state.currentDeviceId } : undefined;

        // ZXing kendi video akÄ±ÅŸÄ±nÄ± baÅŸlatÄ±r
        state.reader.decodeFromVideoDevice(deviceId, video, (result, err) => {
          if (result) {
            barcodeInp.value = result.getText();
            qtyInp.focus();
            if (beepOn.checked){ beep.currentTime=0; beep.play().catch(()=>{}); }
          }
          // err Ã§oÄŸunlukla NotFoundException olur; Ã¶nemsemiyoruz.
        });

        // Zoom iÃ§in track'i al
        setTimeout(()=>{
          if (video.srcObject){
            mediaStream = video.srcObject;
            videoTrack = mediaStream.getVideoTracks()[0] || null;
          }
        }, 400);

      }catch(e){
        console.warn(e);
        statusEl.textContent = 'Tarama baÅŸlatÄ±lamadÄ±';
        state.scanning = false;
      }
    }

    function stopScanner(){
      try{ state.reader?.reset(); }catch(_){}
      const stream = video.srcObject;
      if (stream && stream.getTracks){ stream.getTracks().forEach(t=>t.stop()); }
      video.srcObject = null;
      mediaStream = null; videoTrack = null;
      state.scanning = false;
      statusEl.textContent = 'Durduruldu';
    }

    // Zoom (destek varsa)
    zoomSlider.oninput = async ()=>{
      if(!videoTrack) return;
      const caps = videoTrack.getCapabilities?.();
      if(caps?.zoom){
        const v = Math.min(caps.zoom.max, Math.max(caps.zoom.min, Number(zoomSlider.value)));
        try{ await videoTrack.applyConstraints({ advanced:[{ zoom:v }] }); }catch(_){}
      }
    };

    // Foto ile Tara
    photoBtn.onclick = ()=> photoInput.click();
    photoInput.onchange = async (e)=>{
      const file = e.target.files?.[0]; if(!file) return;
      try{
        statusEl.textContent = 'FotoÄŸraftan okuma...';
        const url = URL.createObjectURL(file);
        const reader = new ZXingBrowser.BrowserMultiFormatReader();
        const result = await reader.decodeFromImageUrl(url);
        URL.revokeObjectURL(url);
        if(result){ barcodeInp.value = result.getText(); qtyInp.focus(); statusEl.textContent='FotoÄŸraftan okundu'; if(beepOn.checked){ beep.currentTime=0; beep.play().catch(()=>{});} }
        else{ statusEl.textContent='Barkod bulunamadÄ±'; }
      }catch(err){ statusEl.textContent='OkunamadÄ±'; }
      finally{ photoInput.value=''; }
    };

    // Butonlar & kÄ±sayollar
    document.getElementById('btnStart').onclick = async()=>{ await listCameras(); startScanner(); };
    document.getElementById('btnStop').onclick  = ()=> stopScanner();
    document.getElementById('btnAdd').onclick   = ()=>{ upsert(barcodeInp.value.trim(), qtyInp.value); barcodeInp.value=''; qtyInp.value=1; barcodeInp.focus(); };
    document.getElementById('btnExport').onclick= ()=> exportTXT();
    document.getElementById('btnCSV').onclick   = ()=> exportCSV();
    document.getElementById('btnClear').onclick = ()=>{ if(confirm('Listeyi temizlemek istiyor musun?')){ state.items={}; saveLocal(); render(); } };
    barcodeInp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ document.getElementById('btnAdd').click(); } });
    qtyInp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ document.getElementById('btnAdd').click(); } });

    // BaÅŸlat
    loadLocal(); listCameras();
  </script>
</body>
</html>
