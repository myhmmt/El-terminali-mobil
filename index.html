<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>GenÃ§ Gross Mobil Terminal</title>
  <style>
    :root{
      --bg:#ffffff;
      --card:#f4f7ff;
      --text:#002060;
      --muted:#666;
      --accent:#ff6a00;
      --ok:#1fbf75;
      --warn:#ff5d5d;
    }
    body{font-family:system-ui;margin:0;background:var(--bg);color:var(--text)}
    header{padding:12px;background:var(--accent);text-align:center;color:#fff;font-weight:bold}
    .wrap{max-width:880px;margin:auto;padding:10px}
    .card{margin:10px;padding:10px;background:var(--card);border-radius:12px}
    button{padding:6px 10px;margin:2px;border-radius:8px;border:none;cursor:pointer}
    .primary{background:var(--accent);color:#fff}
    .good{background:var(--ok);color:#fff}
    .warn{background:var(--warn);color:#fff}
    .row{display:flex;flex-wrap:wrap;gap:6px;align-items:center;margin:4px 0}
    label{font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #ccc;padding:6px}
    th{color:#444;text-align:left;background:#eee}
    .right{text-align:right}
    .muted{color:var(--muted);font-size:12px}
    .videoBox{position:relative;border-radius:12px;overflow:hidden;background:#000}
    video{display:block;width:100%;max-height:300px}
    .roi{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;pointer-events:none}
    .roi:after{content:""; width:70%; height:30%; border:2px solid rgba(255,255,255,.8); border-radius:8px}
    .chip{display:inline-block;background:#ddd;color:#333;padding:2px 8px;border-radius:999px;font-size:12px;margin-right:4px}
  </style>
</head>
<body>
  <header>ðŸ“¦ GENÃ‡ GROSS MOBÄ°L TERMÄ°NAL</header>
  <div class="wrap">

    <div class="card">
      <div class="row">
        <label>Kamera:</label>
        <select id="cameraSelect"></select>
        <button id="btnStart" class="primary">KamerayÄ± BaÅŸlat</button>
        <button id="btnStop">Durdur</button>
      </div>
      <div class="videoBox">
        <video id="video" playsinline autoplay muted></video>
        <div class="roi"></div>
      </div>
      <div class="status">
        <span id="scanStatus" class="chip">HazÄ±r</span>
        <span id="fps" class="chip">FPS: -</span>
      </div>
    </div>

    <div class="card">
      <label>Barkod & Adet</label>
      <div class="row">
        <input id="barcode" placeholder="Barkod" style="flex:1;min-width:220px" />
        <button id="btnClearField">Temizle</button>
      </div>

      <div class="row">
        <button id="btnDec">-1</button>
        <input id="qty" type="number" value="1" min="1" style="width:80px;text-align:center" />
        <button id="btnInc">+1</button>
        <button id="btnAdd" class="good">Ekle</button>
      </div>

      <div class="row">
        <strong>ÃœrÃ¼n:</strong> <span id="prodName">-</span> Â· 
        <strong>Fiyat:</strong> <span id="prodPrice">-</span>
      </div>

      <label>Dosya AdÄ±:</label>
      <input id="filename" placeholder="sayim" style="width:60%" />

      <div class="row" style="margin-top:8px">
        <button id="btnExport" class="primary">TXT Olarak DÄ±ÅŸa Aktar</button>
        <button id="btnCSV">CSV Olarak DÄ±ÅŸa Aktar</button>
        <button id="btnClear" class="warn">Listeyi Temizle</button>
      </div>

      <table>
        <thead><tr><th>Barkod</th><th>Ä°sim</th><th class="right">Adet</th><th></th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      Toplam satÄ±r: <span id="totalRows">0</span> Â· Toplam adet: <span id="totalQty">0</span>
    </div>
  </div>

  <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  <script>
    const state = { items:{}, scanning:false };
    let mediaStream=null, rafId=null, frames=0;
    let duplicateGuard = { code:null, until:0 };
    let lastOp = null;

    const selCam = document.getElementById('cameraSelect');
    const video  = document.getElementById('video');
    const statusEl = document.getElementById('scanStatus');
    const fpsEl  = document.getElementById('fps');
    const barcodeInp = document.getElementById('barcode');
    const qtyInp  = document.getElementById('qty');
    const tbody   = document.getElementById('tbody');
    const totalRows = document.getElementById('totalRows');
    const totalQty  = document.getElementById('totalQty');
    const filenameInp = document.getElementById('filename');
    const beep = document.getElementById('beep');
    const prodNameEl = document.getElementById('prodName');
    const prodPriceEl = document.getElementById('prodPrice');

    // Ã¼rÃ¼n map dosyadan doldurulacak (JSONâ€™a Ã§evrilmiÅŸ)
    const productMap = {}; // Ã¶rn: { "8697449113051": {name:"ÃœRÃœN ADI", price:"259.90"} }

    function showProductInfo(code){
      const p = productMap[code];
      if(p){
        prodNameEl.textContent = p.name || "-";
        prodPriceEl.textContent = p.price || "-";
      } else {
        prodNameEl.textContent = "BulunamadÄ±";
        prodPriceEl.textContent = "-";
      }
    }

    function render(){
      tbody.innerHTML='';
      let sum=0;
      Object.entries(state.items).forEach(([c,q])=>{
        sum += Number(q)||0;
        const p = productMap[c]||{};
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${c}</td><td>${p.name||'-'}</td><td class="right">${q}</td><td><button onclick="del('${c}')">Sil</button></td>`;
        tbody.appendChild(tr);
      });
      totalRows.textContent = Object.keys(state.items).length;
      totalQty.textContent  = sum;
    }
    function del(c){ delete state.items[c]; save(); render(); }
    function upsert(c,q){
      if(!c) return;
      const n=Math.max(1,Number(q)||1);
      state.items[c]=(Number(state.items[c])||0)+n;
      lastOp={code:c, qty:n};
      save(); render();
    }
    function save(){ localStorage.setItem('barcodeItems', JSON.stringify(state.items)); }
    function load(){ const raw=localStorage.getItem('barcodeItems'); if(raw){ try{state.items=JSON.parse(raw);}catch{} } render(); }

    function dl(name,content,type){
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([content],{type}));
      a.download=name; a.click(); URL.revokeObjectURL(a.href);
    }
    function exportTXT(){ const lines=Object.entries(state.items).map(([c,q])=>`${c};${q}`); dl((filenameInp.value||'sayim')+'.txt', lines.join('\n'),'text/plain'); }
    function exportCSV(){ const lines=['barcode,qty',...Object.entries(state.items).map(([c,q])=>`${c},${q}`)]; dl((filenameInp.value||'sayim')+'.csv', lines.join('\n'),'text/csv'); }

    async function listCameras(){
      try{
        const devices = await navigator.mediaDevices.enumerateDevices();
        const vids = devices.filter(d=>d.kind==='videoinput');
        selCam.innerHTML='';
        vids.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||`Kamera ${i+1}`; selCam.appendChild(o); });
        if(vids[0]) selCam.value = vids[0].deviceId;
      }catch(e){}
    }

    async function start(){
      stop();
      statusEl.textContent = 'Kamera aÃ§Ä±lÄ±yor...';
      try{
        mediaStream = await navigator.mediaDevices.getUserMedia({
          video:{deviceId:{exact:selCam.value}}, audio:false
        });
        video.srcObject=mediaStream; await video.play();
        state.scanning=true;
        runNativeLoop();
        fpsCounter();
        statusEl.textContent='Tarama aktif';
      }catch(e){ statusEl.textContent='Tarama baÅŸlatÄ±lamadÄ±'; }
    }

    function stop(){
      cancelAnimationFrame(rafId);
      const s=video.srcObject; if(s?.getTracks) s.getTracks().forEach(t=>t.stop());
      video.srcObject=null; mediaStream=null; state.scanning=false; fpsEl.textContent='FPS: -'; statusEl.textContent='Durduruldu';
    }

    let detector=null, off=null, octx=null;
    async function runNativeLoop(){
      if(!('BarcodeDetector' in window)){ statusEl.textContent='Desteklenmiyor'; return; }
      if(!detector){ detector=new BarcodeDetector({formats:['ean_13','ean_8','code_128','code_39','itf','upc_e','upc_a']}); }
      if(!off){ off=document.createElement('canvas'); octx=off.getContext('2d',{willReadFrequently:true}); }
      const loop=async()=>{
        if(!state.scanning) return;
        frames++;
        const vw=video.videoWidth, vh=video.videoHeight;
        if(vw&&vh){
          const rw=Math.floor(vw*0.7), rh=Math.floor(vh*0.3);
          const rx=Math.floor((vw-rw)/2), ry=Math.floor((vh-rh)/2);
          off.width=rw; off.height=rh; octx.drawImage(video,rx,ry,rw,rh,0,0,rw,rh);
          try{
            const d=await detector.detect(off);
            if(d && d.length){ onCode((d[0].rawValue||'').trim()); }
          }catch(_){}
        }
        rafId=requestAnimationFrame(loop);
      };
      loop();
    }

    function onCode(text){
      if(!text) return;
      const now=performance.now();
      if(text===duplicateGuard.code && now<duplicateGuard.until) return;
      duplicateGuard={code:text, until:now+1500};
      barcodeInp.value=text;
      showProductInfo(text);
      try{beep.currentTime=0; beep.play();}catch(_){}
      if(navigator.vibrate) navigator.vibrate(30);
    }

    function fpsCounter(){
      let last=performance.now();
      const tick=()=>{ if(!state.scanning) return; const now=performance.now(); if(now-last>=1000){ fpsEl.textContent='FPS: '+frames; frames=0; last=now; } requestAnimationFrame(tick); };
      tick();
    }

    // UI events
    document.getElementById('btnStart').onclick=()=>{listCameras(); start();};
    document.getElementById('btnStop').onclick=()=>stop();
    document.getElementById('btnAdd').onclick=()=>{ upsert(barcodeInp.value.trim(), qtyInp.value); barcodeInp.value=''; qtyInp.value=1; showProductInfo(''); };
    document.getElementById('btnExport').onclick=()=>exportTXT();
    document.getElementById('btnCSV').onclick=()=>exportCSV();
    document.getElementById('btnClear').onclick=()=>{ if(confirm('Listeyi temizlemek istiyor musun?')){ state.items={}; save(); render(); } };
    document.getElementById('btnClearField').onclick=()=>{ barcodeInp.value=''; showProductInfo(''); };

    document.getElementById('btnInc').onclick=()=>{ qtyInp.value=Number(qtyInp.value||1)+1; };
    document.getElementById('btnDec').onclick=()=>{ qtyInp.value=Math.max(1,Number(qtyInp.value||1)-1); };

    barcodeInp.addEventListener('input',()=>{ const code=barcodeInp.value.trim(); if(code.length>=8) showProductInfo(code); });
    barcodeInp.addEventListener('blur',()=>{ const code=barcodeInp.value.trim(); if(code) showProductInfo(code); });

    // BaÅŸlat
    load(); listCameras();
  </script>
</body>
</html>
