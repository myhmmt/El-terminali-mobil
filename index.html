<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Barkod + Adet â†’ TXT (HÄ±zlÄ± Tarama)</title>
  <style>
    :root{--bg:#0b1220;--card:#1c2944;--text:#fff;--muted:#9cb0d2;--accent:#1677ff;--ok:#1fbf75;--warn:#ff5d5d}
    *{box-sizing:border-box}
    body{font-family:system-ui;margin:0;background:var(--bg);color:var(--text)}
    header{padding:10px;background:#111a2b;text-align:center}
    .wrap{max-width:880px;margin:auto}
    .card{margin:10px;padding:10px;background:var(--card);border-radius:12px}
    button{padding:8px 12px;margin:4px;border-radius:10px;border:none;cursor:pointer}
    .primary{background:var(--accent);color:#fff}
    .good{background:var(--ok);color:#072b14}
    .warn{background:var(--warn);color:#2b0b0b}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    label{font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border-bottom:1px solid #2a3756;padding:6px}
    th{color:#7f8ca8;text-align:left}
    .right{text-align:right}
    .muted{color:var(--muted);font-size:12px}
    /* Kamera alanÄ± + ROI */
    .videoBox{position:relative;border-radius:12px;overflow:hidden;background:#000}
    video{display:block;width:100%;max-height:320px}
    .roi{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      pointer-events:none;
    }
    .roi:after{
      content:""; width:68%; height:32%;
      border:2px solid rgba(255,255,255,.8);
      border-radius:10px;
      box-shadow:0 0 0 200vmax rgba(0,0,0,.35) inset;
    }
    .status{margin-top:6px}
    .chip{display:inline-block;background:#10203c;color:#9cb0d2;border:1px solid #2a3756;padding:2px 8px;border-radius:999px;font-size:12px}
    input[type="range"]{vertical-align:middle}
  </style>
</head>
<body>
  <header><h1>ðŸ“¦ Barkod + Adet â†’ TXT</h1></header>
  <div class="wrap">

    <div class="card">
      <div class="row">
        <label>Kamera:</label>
        <select id="cameraSelect"></select>
        <button id="btnStart" class="primary">KamerayÄ± BaÅŸlat</button>
        <button id="btnStop">Durdur</button>
        <label>YakÄ±nlaÅŸtÄ±rma:
          <input id="zoom" type="range" min="1" max="5" step="0.1" value="1">
        </label>
        <label style="display:inline-flex;gap:6px;align-items:center">
          <input id="beepOn" type="checkbox" checked> Bip
        </label>
      </div>

      <div class="videoBox">
        <video id="video" playsinline autoplay muted></video>
        <div class="roi"></div>
      </div>
      <div class="status">
        <span id="scanStatus" class="chip">HazÄ±r</span>
        <span id="tech" class="chip">Motor: -</span>
        <span id="fps" class="chip">FPS: -</span>
      </div>
      <div class="muted">Ä°pucu: Barkodu dik tut, ROI kutusunun ortasÄ±na getir. Mesafe 15â€“25 cm, iyi Ä±ÅŸÄ±k.</div>
    </div>

    <div class="card">
      <label>Barkod & Adet</label>
      <div class="row">
        <input id="barcode" placeholder="Barkod" style="flex:1;min-width:220px" />
        <input id="qty" type="number" value="1" min="1" style="width:110px" />
        <button id="btnAdd" class="good">Ekle</button>
      </div>

      <label>Dosya AdÄ±:</label>
      <input id="filename" placeholder="sayim" style="width:60%" />

      <div class="row" style="margin-top:8px">
        <button id="btnExport" class="primary">TXT Olarak DÄ±ÅŸa Aktar</button>
        <button id="btnCSV">CSV Olarak DÄ±ÅŸa Aktar</button>
        <button id="btnClear" class="warn">Listeyi Temizle</button>
      </div>

      <table>
        <thead><tr><th>Barkod</th><th class="right">Adet</th><th></th></tr></thead>
        <tbody id="tbody"></tbody>
      </table>
      Toplam: <span id="totalRows">0</span>
    </div>

    <!-- Ses -->
    <audio id="beep" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

  </div>

  <!-- ZXing fallback -->
  <script src="https://unpkg.com/@zxing/browser@0.1.6"></script>
  <script>
    // ---- Durum
    const state = { items:{}, scanning:false, currentDeviceId:null, reader:null, engine:'-' };
    let mediaStream=null, videoTrack=null, rafId=null, fpsLast=performance.now(), frames=0;
    let duplicateGuard = { code:null, until:0 };

    // ---- Elemanlar
    const selCam = document.getElementById('cameraSelect');
    const video  = document.getElementById('video');
    const statusEl = document.getElementById('scanStatus');
    const techEl = document.getElementById('tech');
    const fpsEl  = document.getElementById('fps');
    const barcodeInp = document.getElementById('barcode');
    const qtyInp  = document.getElementById('qty');
    const tbody   = document.getElementById('tbody');
    const totalRows = document.getElementById('totalRows');
    const filenameInp = document.getElementById('filename');
    const beep = document.getElementById('beep');
    const beepOn = document.getElementById('beepOn');
    const zoomSlider = document.getElementById('zoom');

    // ---- Liste
    function render(){
      tbody.innerHTML='';
      Object.entries(state.items).forEach(([c,q])=>{
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${c}</td><td class="right">${q}</td><td><button onclick="del('${c}')">Sil</button></td>`;
        tbody.appendChild(tr);
      });
      totalRows.textContent = Object.keys(state.items).length;
    }
    function del(c){ delete state.items[c]; save(); render(); }
    function upsert(c,q){ if(!c) return; const n=Math.max(1,Number(q)||1); state.items[c]=(Number(state.items[c])||0)+n; save(); render(); }
    function save(){ localStorage.setItem('barcodeItems', JSON.stringify(state.items)); }
    function load(){ const raw=localStorage.getItem('barcodeItems'); if(raw){ try{state.items=JSON.parse(raw);}catch{} } render(); }

    // ---- Export
    function dl(name,content,type){ const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([content],{type})); a.download=name; a.click(); URL.revokeObjectURL(a.href); }
    function exportTXT(){ const lines=Object.entries(state.items).map(([c,q])=>`${c};${q}`); dl((filenameInp.value||'sayim')+'.txt', lines.join('\n'), 'text/plain'); }
    function exportCSV(){ const lines=['barcode,qty',...Object.entries(state.items).map(([c,q])=>`${c},${q}`)]; dl((filenameInp.value||'sayim')+'.csv', lines.join('\n'), 'text/csv'); }

    // ---- Kamera listesi
    async function listCameras(){
      try{
        const devices = await ZXingBrowser.BrowserMultiFormatReader.listVideoInputDevices();
        selCam.innerHTML='';
        devices.forEach((d,i)=>{ const o=document.createElement('option'); o.value=d.deviceId; o.textContent=d.label||`Kamera ${i+1}`; selCam.appendChild(o); });
        const rear = devices.find(d=>/back|rear|arka/i.test(d.label||'')); 
        state.currentDeviceId = rear?.deviceId || devices[0]?.deviceId || null;
        if(state.currentDeviceId) selCam.value = state.currentDeviceId;
      }catch(e){ /* boÅŸ geÃ§ */ }
    }
    selCam.onchange = ()=>{ state.currentDeviceId = selCam.value; if(state.scanning) start(); };

    // ---- BaÅŸlat / Durdur
    async function start(){
      stop();
      statusEl.textContent = 'Kamera aÃ§Ä±lÄ±yor...';
      try{
        const constraints = {
          video: state.currentDeviceId
            ? { deviceId:{exact:state.currentDeviceId}, width:{ideal:1920}, height:{ideal:1080}, focusMode:'continuous' }
            : { facingMode:{ideal:'environment'}, width:{ideal:1920}, height:{ideal:1080}, focusMode:'continuous' },
          audio:false
        };
        mediaStream = await navigator.mediaDevices.getUserMedia(constraints);
        video.srcObject = mediaStream;
        await video.play();
        videoTrack = mediaStream.getVideoTracks()[0] || null;
        state.scanning = true;

        // DonanÄ±msal zoom desteÄŸi varsa baÄŸla
        zoomSlider.oninput = async ()=>{
          if(!videoTrack) return;
          const caps = videoTrack.getCapabilities?.();
          if(caps?.zoom){
            const v = Math.min(caps.zoom.max, Math.max(caps.zoom.min, Number(zoomSlider.value)));
            try{ await videoTrack.applyConstraints({ advanced:[{ zoom:v }] }); }catch(_){}
          }
        };

        // Motor seÃ§imi: BarcodeDetector -> ZXing
        const hasNative = ('BarcodeDetector' in window);
        if(hasNative){
          state.engine = 'BarcodeDetector';
          techEl.textContent = 'Motor: Yerel (hÄ±zlÄ±)';
          runNativeLoop();
        }else{
          state.engine = 'ZXing';
          techEl.textContent = 'Motor: ZXing';
          runZXing();
        }
        statusEl.textContent = 'Tarama aktif';
        fpsCounter();
      }catch(e){
        statusEl.textContent = 'Tarama baÅŸlatÄ±lamadÄ±';
      }
    }

    function stop(){
      try{ state.reader?.reset?.(); }catch(_){}
      cancelAnimationFrame(rafId); rafId=null; frames=0; fpsEl.textContent='FPS: -';
      const s = video.srcObject; if(s?.getTracks) s.getTracks().forEach(t=>t.stop());
      video.srcObject=null; mediaStream=null; videoTrack=null; state.scanning=false;
      statusEl.textContent='Durduruldu';
    }

    // ---- Native (BarcodeDetector) dÃ¶ngÃ¼sÃ¼: ROI kÄ±rpÄ±p oku
    let detector = null, off=null, octx=null;
    async function runNativeLoop(){
      if(!detector){
        detector = new BarcodeDetector({ formats: ['ean_13','ean_8','code_128','code_39','itf','upc_e','upc_a'] });
      }
      if(!off){
        off = document.createElement('canvas'); octx = off.getContext('2d', { willReadFrequently:true });
      }
      const loop = async ()=>{
        if(!state.scanning) return;
        frames++;
        const vw = video.videoWidth, vh = video.videoHeight;
        if(vw && vh){
          // ROI: merkezde 68%x32%
          const rw = Math.floor(vw*0.68), rh = Math.floor(vh*0.32);
          const rx = Math.floor((vw - rw)/2), ry = Math.floor((vh - rh)/2);
          off.width = rw; off.height = rh;
          octx.drawImage(video, rx, ry, rw, rh, 0, 0, rw, rh);
          try{
            const bit = off; // direkt canvas
            const d = await detector.detect(bit);
            if(d && d.length){
              const code = (d[0].rawValue||'').trim();
              onCode(code);
            }
          }catch(_){}
        }
        rafId = requestAnimationFrame(loop);
      };
      loop();
    }

    // ---- ZXing sÃ¼rekli Ã§Ã¶zÃ¼m
    async function runZXing(){
      try{
        state.reader = new ZXingBrowser.BrowserMultiFormatReader();
        // Sadece yaygÄ±n formatlarÄ± ipucu verelim (performans)
        try{
          const formats=[ZXingBrowser.BarcodeFormat.EAN_13,ZXingBrowser.BarcodeFormat.EAN_8,ZXingBrowser.BarcodeFormat.CODE_128,ZXingBrowser.BarcodeFormat.CODE_39,ZXingBrowser.BarcodeFormat.ITF];
          state.reader.hints = new Map([[ZXingBrowser.DecodeHintType.POSSIBLE_FORMATS, formats]]);
        }catch(_){}
        await state.reader.decodeFromVideoElementContinuously(video,(res,err)=>{
          frames++;
          if(res){ onCode(res.getText()); }
        });
      }catch(_){}
    }

    // ---- Kod yakalandÄ±
    function onCode(text){
      if(!text) return;
      const now = performance.now();
      if(duplicateGuard.code === text && now < duplicateGuard.until) return; // 1.5 sn iÃ§inde aynÄ± kodu tekrar etme
      duplicateGuard = { code:text, until: now + 1500 };

      barcodeInp.value = text;
      qtyInp.focus();
      if(beepOn.checked){ try{beep.currentTime=0; beep.play();}catch(_){} }
      if(navigator.vibrate) navigator.vibrate(35);
    }

    // ---- FPS Ã¶lÃ§er
    function fpsCounter(){
      const tick = ()=>{
        if(!state.scanning) return;
        const now = performance.now();
        if(now - fpsLast >= 1000){
          fpsEl.textContent = 'FPS: ' + frames;
          frames = 0; fpsLast = now;
        }
        requestAnimationFrame(tick);
      };
      tick();
    }

    // ---- UI butonlarÄ±
    document.getElementById('btnStart').onclick = async()=>{ await listCameras(); start(); };
    document.getElementById('btnStop').onclick  = ()=> stop();
    document.getElementById('btnAdd').onclick   = ()=>{ upsert(barcodeInp.value.trim(), qtyInp.value); barcodeInp.value=''; qtyInp.value=1; barcodeInp.focus(); };
    document.getElementById('btnExport').onclick= ()=> exportTXT();
    document.getElementById('btnCSV').onclick   = ()=> exportCSV();
    document.getElementById('btnClear').onclick = ()=>{ if(confirm('Listeyi temizlemek istiyor musun?')){ state.items={}; save(); render(); } };
    barcodeInp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ document.getElementById('btnAdd').click(); } });
    qtyInp.addEventListener('keydown', e=>{ if(e.key==='Enter'){ document.getElementById('btnAdd').click(); } });

    // ---- BaÅŸlat
    load(); listCameras();
  </script>
</body>
</html>
